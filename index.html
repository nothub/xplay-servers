<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>xplay.gg servers</title>
    <link href="style.css" rel="stylesheet">
    <script src="sorttable.js"
            integrity="sha512-M73DiNgWyrIZDuM5GBQwdKPRvI2jFbDWEX64Iz2KftUXUqomQZKWwGEgxvruYFPUWJ/KKnWQhGE51p6Ey2AICA=="
            crossorigin="anonymous"></script>
</head>
<body>
<header>
    <h1>xplay.gg servers</h1>
</header>
<main id='main'></main>
<script defer>
    function addHeader(table) {
        let row = table.insertRow()
        for (let text of [
            'link',
            'map',
            'players on',
            'players max',
            'average faceit',
            'country',
            'tick rate'
        ]) {
            let th = document.createElement('th')
            th.innerText = text
            row.appendChild(th)
        }
    }

    function addServer(table, server) {
        let row = table.insertRow()
        let cell = row.insertCell()
        let link = document.createElement('a')
        link.innerText = `${server.IP}:${server.Port}`
        link.href = `steam://connect/${server.IP}:${server.Port}`
        cell.appendChild(link)
        for (let text of [
            server.CurrentMap,
            server.Online,
            server.TotalSlots,
            server.AverageFaceItLvl,
            server.CountryCode,
            server.TickRate
        ]) {
            let cell = row.insertCell()
            cell.innerText = text
        }
    }

    (async function () {
        let modes = []
        await fetch('https://xplay.gg/api/play/getCurrentOnlineStatus', {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            },
        })
            .then(res => res.json())
            .then(data => modes = data.GameModes.cs2)
            .catch(err => console.log(`Failed to fetch modes; ${err}`))

        for (const mode of modes) {
            let h = document.createElement('h3')
            h.innerText = mode.Slug
            document.getElementById('main').appendChild(h)

            let t = document.createElement('table')
            t.className = 'sortable'
            addHeader(t);
            document.getElementById('main').appendChild(t)

            let servers = []
            await fetch('https://xplay.gg/api/play/getServers', {
                method: 'POST',
                body: JSON.stringify({modeID: mode.GameModeID, showFullServers: true}),
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
            })
                .then(res => res.json())
                .then(data => servers = data)
                .catch(err => console.log(`Failed to fetch servers for ${mode.Slug}; ${err}`))

            for (let server of servers) {
                addServer(t, server);
            }
            sorttable.makeSortable(t);
        }
    })()
</script>
</body>
</html>
